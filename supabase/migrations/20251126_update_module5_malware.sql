BEGIN;

-- Module 5: Malware Hunter
-- Stage 26: Virus vs Worm (matching)
UPDATE stages SET
  title = 'Virus vs Worm Characteristics',
  description = 'Match malware behaviors to virus or worm classification.',
  scenario = 'Security analysts need to classify malware samples. Match each characteristic to either Virus or Worm based on propagation method and host dependency.',
  challenge_type = 'matching',
  challenge_data = '{
    "pairs": [
      {"id": "char1", "left": "Requires host file to execute", "right": "Virus"},
      {"id": "char2", "left": "Self-replicates across networks", "right": "Worm"},
      {"id": "char3", "left": "Spreads without user action", "right": "Worm"},
      {"id": "char4", "left": "Needs user to run infected file", "right": "Virus"}
    ]
  }'::jsonb,
  points = 80
WHERE id = 26;

DELETE FROM hints WHERE stage_id = 26;
INSERT INTO hints (stage_id, hint_number, hint_text, penalty_points) VALUES
  (26, 1, 'Viruses attach to files and need user action. Worms are standalone and spread automatically.', 5),
  (26, 2, 'Virus: needs host file, requires user execution. Worm: self-replicating, spreads without user action.', 10);

-- Stage 27: Trojan Detection (scenario)
UPDATE stages SET
  title = 'Trojan Horse Identification',
  description = 'Identify trojan behavior patterns from system activity.',
  scenario = 'A user downloaded what appeared to be legitimate software. Now the system shows unauthorized remote access connections and modified firewall rules. What type of malware is this?',
  challenge_type = 'scenario',
  challenge_data = '{
    "sections": [{
      "id": "malware-type",
      "question": "Software disguising malicious intent as legitimate functionality indicates which malware type?",
      "options": [
        {"id": "trojan", "text": "Trojan Horse - masquerades as legitimate software", "correct": true},
        {"id": "virus", "text": "Virus - infects other files"},
        {"id": "worm", "text": "Worm - self-replicates across network"},
        {"id": "adware", "text": "Adware - displays unwanted advertisements"}
      ]
    }],
    "correctChoice": "trojan"
  }'::jsonb,
  points = 100
WHERE id = 27;

DELETE FROM hints WHERE stage_id = 27;
INSERT INTO hints (stage_id, hint_number, hint_text, penalty_points) VALUES
  (27, 1, 'Trojans disguise themselves as useful software while containing malicious payloads like backdoors.', 5),
  (27, 2, 'Remote access connections and firewall changes indicate backdoor trojan functionality.', 10);

-- Stage 28: Rootkit Indicators (infection-signs - reuse existing component)
UPDATE stages SET
  title = 'Rootkit Detection Indicators',
  description = 'Identify signs that indicate rootkit infection on a system.',
  scenario = 'A security scan shows processes that cannot be terminated, hidden files consuming disk space, and drivers loaded that do not match system records. Select all indicators that suggest rootkit presence.',
  challenge_type = 'infection-signs',
  challenge_data = '{
    "signs": [
      {"id": "sign1", "text": "Unkillable processes in task manager", "isSuspicious": true},
      {"id": "sign2", "text": "Normal Windows update notifications", "isSuspicious": false},
      {"id": "sign3", "text": "Hidden files visible only via specialized tools", "isSuspicious": true},
      {"id": "sign4", "text": "Unsigned kernel drivers loaded at boot", "isSuspicious": true},
      {"id": "sign5", "text": "Standard antivirus software running", "isSuspicious": false},
      {"id": "sign6", "text": "Discrepancies between file counts in different tools", "isSuspicious": true}
    ],
    "correctSigns": ["sign1", "sign3", "sign4", "sign6"],
    "minCorrectIdentifications": 3
  }'::jsonb,
  points = 120
WHERE id = 28;

DELETE FROM hints WHERE stage_id = 28;
INSERT INTO hints (stage_id, hint_number, hint_text, penalty_points) VALUES
  (28, 1, 'Rootkits hide at kernel level, causing unkillable processes, hidden files, and unsigned drivers.', 5),
  (28, 2, 'Look for: unkillable processes, hidden files, unsigned drivers, file count discrepancies.', 10);

-- Stage 30: APT Analysis (drag-drop timeline)
UPDATE stages SET
  title = 'APT Attack Timeline Reconstruction',
  description = 'Order the stages of an Advanced Persistent Threat attack campaign.',
  scenario = 'Forensic analysis revealed a multi-month APT campaign. Arrange the attack stages in the correct chronological order from initial compromise to data exfiltration.',
  challenge_type = 'drag-drop',
  challenge_data = '{
    "items": [
      {"id": "stage1", "text": "Initial phishing email with malicious attachment"},
      {"id": "stage2", "text": "Privilege escalation via exploit"},
      {"id": "stage3", "text": "Lateral movement to high-value targets"},
      {"id": "stage4", "text": "Data exfiltration via encrypted channel"},
      {"id": "stage5", "text": "Persistence mechanism installed"},
      {"id": "stage6", "text": "Credential harvesting from compromised systems"}
    ],
    "zones": [
      {"id": "phase1", "label": "Initial Access", "correctItems": ["stage1"]},
      {"id": "phase2", "label": "Establish Foothold", "correctItems": ["stage5", "stage2"]},
      {"id": "phase3", "label": "Expand Access", "correctItems": ["stage6", "stage3"]},
      {"id": "phase4", "label": "Complete Mission", "correctItems": ["stage4"]}
    ]
  }'::jsonb,
  points = 150
WHERE id = 30;

DELETE FROM hints WHERE stage_id = 30;
INSERT INTO hints (stage_id, hint_number, hint_text, penalty_points) VALUES
  (30, 1, 'APT kill chain: Initial Access → Establish Foothold → Expand Access → Complete Mission', 5),
  (30, 2, 'Order: Phishing → Persistence+Escalation → Credentials+Lateral Movement → Exfiltration', 10);

COMMIT;
