import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Bug, ArrowLeft, Shield, AlertTriangle, CheckCircle, Zap, HardDrive, Wifi, Monitor } from 'lucide-react';
import { default as EnhancedSimulation } from './EnhancedSimulation';
import { ScoreData } from './types';

interface ChatMessage {
  id: string;
  type: 'system' | 'user' | 'simulation';
  content: string;
  timestamp: Date;
  options?: string[];
}

const MalwareIncidentSimEnhanced: React.FC = () => {
  const [currentStep, setCurrentStep] = useState(0);
  const [isSimulationActive, setIsSimulationActive] = useState(false);
  const [chatHistory, setChatHistory] = useState<ChatMessage[]>([
    {
      id: '1',
      type: 'system',
      content: 'Welcome to Malware Incident Handling Training! Learn to detect, contain, and recover from malware infections.',
      timestamp: new Date(),
    },
  ]);
  const [selectedThreat, setSelectedThreat] = useState<string | null>(null);

  const simulationSteps = [
    {
      type: 'multiple-choice',
      title: 'Malware Threat Landscape',
      description: 'Understand current malware threats and their characteristics.',
      content: {
        question: 'What distinguishes ransomware from other types of malware?',
        options: [
          'It steals personal information',
          'It encrypts files and demands payment for decryption',
          'It spreads through email attachments',
          'It creates backdoors for remote access'
        ],
        correct: 1,
        explanation: 'Ransomware uniquely encrypts victim files and demands payment (ransom) for decryption keys, making it financially motivated and disruptive.'
      }
    },
    {
      type: 'drag-drop',
      title: 'Malware Classification',
      description: 'Categorize different types of malware by their behavior and purpose.',
      content: {
        items: [
          { id: '1', content: ' encrypts files and demands payment', category: 'ransomware' },
          { id: '2', content: 'Records keystrokes to steal credentials', category: 'spyware' },
          { id: '3', content: 'Disguises itself as legitimate software', category: 'trojan' },
          { id: '4', content: 'Self-replicates across networks', category: 'virus' },
          { id: '5', content: 'Provides unauthorized remote access', category: 'backdoor' },
          { id: '6', content: 'Displays unwanted advertisements', category: 'adware' },
          { id: '7', content: 'Uses victim\'s computer to mine cryptocurrency', category: 'cryptominer' },
          { id: '8', content: 'Transforms computers into botnet participants', category: 'botnet' },
        ],
        dropZones: [
          { id: 'ransomware', title: 'Ransomware', description: 'File encryption and payment demands', accepts: ['ransomware'] },
          { id: 'spyware', title: 'Spyware', description: 'Information theft and surveillance', accepts: ['spyware'] },
          { id: 'trojan', title: 'Trojan Horses', description: 'Disguised malicious software', accepts: ['trojan'] },
          { id: 'self-replicating', title: 'Self-Replicating', description: 'Network-spreading malware', accepts: ['virus', 'botnet'] },
        ]
      }
    },
    {
      type: 'chat',
      title: 'Initial Malware Detection',
      description: 'Experience the first signs of a malware infection and decision-making process.',
      content: {
        scenario: 'Employees report that computers are running slowly, and you notice unusual network traffic patterns. One user mentions files being renamed with strange extensions.',
        messages: [
          {
            id: '1',
            type: 'simulation',
            content: 'IT Support: "Several users are reporting their files have .encrypted extensions. Antivirus is showing multiple threat detections, but they keep coming back."',
            options: ['Restart all affected computers', 'Disconnect from network immediately', 'Check if it\'s a false positive', 'Run full antivirus scans']
          },
          {
            id: '2',
            type: 'simulation',
            content: 'Network monitoring shows data being sent to unknown external IPs. Users can\'t access encrypted files, and there\'s a ransom note demanding Bitcoin payment.',
            options: ['Pay the ransom quickly', 'Isolate affected systems and call incident response', 'Try to decrypt files manually', 'Wait for more information']
          },
        ]
      }
    },
    {
      type: 'matching',
      title: 'Malware Attack Vectors',
      description: 'Match malware types with their common infection methods.',
      content: {
        pairs: [
          { left: 'Email phishing attachments', right: 'Common delivery method for most malware', category: 'delivery' },
          { left: 'Exploit kits and drive-by downloads', right: 'Web-based infections through compromised sites', category: 'delivery' },
          { left: 'USB drives and removable media', right: 'Physical media infections', category: 'delivery' },
          { left: 'Remote Desktop Protocol (RDP)', right: 'Network-based attacks', category: 'delivery' },
          { left: 'Software supply chain attacks', right: 'Compromised legitimate software updates', category: 'delivery' },
          { left: 'Social engineering and trojans', right: 'User-initiated installations', category: 'delivery' },
        ]
      }
    },
    {
      type: 'timeline',
      title: 'Malware Incident Timeline',
      description: 'Understand the critical timeline for malware incident response.',
      content: {
        events: [
          { id: '1', content: 'Detect malware infection indicators', timestamp: 'minute-0' },
          { id: '2', content: 'Isolate infected systems from network', timestamp: 'minute-5' },
          { id: '3', content: 'Activate incident response team', timestamp: 'hour-1' },
          { id: '4', content: 'Identify malware type and spread scope', timestamp: 'hour-2' },
          { id: '5', content: 'Remove malware and clean systems', timestamp: 'day-1' },
          { id: '6', content: 'Restore from clean backups', timestamp: 'day-2' },
          { id: '7', content: 'Implement security improvements', timestamp: 'week-1' },
          { id: '8', content: 'Conduct post-incident analysis', timestamp: 'week-2' },
        ],
        correctOrder: ['1', '2', '3', '4', '5', '6', '7', '8']
      }
    },
    {
      type: 'multiple-choice',
      title: 'Containment Strategies',
      description: 'Learn effective malware containment and isolation techniques.',
      content: {
        question: 'What is the first priority when containing a malware outbreak?',
        options: [
          'Identify the malware type and creator',
          'Prevent further spread while preserving evidence',
          'Restore normal business operations immediately',
          'Notify customers and authorities'
        ],
        correct: 1,
        explanation: 'Immediate containment focuses on stopping malware spread while preserving forensic evidence. Speed is critical to minimize damage.'
      }
    },
    {
      type: 'drag-drop',
      title: 'Malware Analysis Tools',
      description: 'Categorize tools used in malware investigation and removal.',
      content: {
        items: [
          { id: '1', content: 'Signature-based antivirus software', category: 'detection' },
          { id: '2', content: 'Behavioral analysis engines', category: 'detection' },
          { id: '3', content: 'Network traffic analysis', category: 'monitoring' },
          { id: '4', content: 'Sandbox environments for testing', category: 'analysis' },
          { id: '5', content: 'Static code analysis tools', category: 'analysis' },
          { id: '6', content: 'System restore and backup recovery', category: 'remediation' },
          { id: '7', content: 'Endpoint detection and response (EDR)', category: 'monitoring' },
          { id: '8', content: 'Malware removal utilities', category: 'remediation' },
        ],
        dropZones: [
          { id: 'detection', title: 'Detection Tools', description: 'Identify and classify malware', accepts: ['detection'] },
          { id: 'analysis', title: 'Analysis Tools', description: 'Deep malware investigation', accepts: ['analysis'] },
          { id: 'monitoring', title: 'Monitoring Tools', description: 'Real-time threat detection', accepts: ['monitoring'] },
          { id: 'remediation', title: 'Remediation Tools', description: 'Remove and restore from malware', accepts: ['remediation'] },
        ]
      }
    },
    {
      type: 'chat',
      title: 'Ransomware Recovery Decision',
      description: 'Navigate the complex decision-making process during a ransomware attack.',
      content: {
        scenario: 'Your organization is hit by ransomware. Systems are encrypted, backup servers are compromised, and attackers demand $500,000 in Bitcoin. Business operations are completely halted.',
        messages: [
          {
            id: '1',
            type: 'simulation',
            content: 'Attacker message: "Your files are encrypted. Pay 10 Bitcoin within 72 hours or your data will be published. Double the ransom after deadline."',
            options: ['Pay immediately to minimize damage', 'Contact law enforcement and insurance', 'Try to negotiate for lower amount', 'Attempt to restore from backups']
          },
          {
            id: '2',
            type: 'simulation',
            content: 'Cyber insurance provider asks: "Do you have clean, offline backups? Have you contacted law enforcement? What is your recovery timeline?"',
            options: ['We don\'t have clean backups', 'We have clean backups but they\'re compromised', 'Yes, we have offline backups ready', 'We\'re not sure about our backup status']
          },
        ]
      }
    },
    {
      type: 'matching',
      title: 'Advanced Persistent Threats (APTs)',
      description: 'Understand sophisticated malware campaigns and nation-state threats.',
      content: {
        pairs: [
          { left: 'Multi-stage payload delivery', right: 'Gradual malware deployment to avoid detection', category: 'apt-tactic' },
          { left: 'Lateral movement and persistence', right: 'Long-term network infiltration', category: 'apt-tactic' },
          { left: 'Living-off-the-land techniques', right: 'Using legitimate system tools', category: 'apt-tactic' },
          { left: 'Zero-day exploit usage', right: 'Previously unknown vulnerabilities', category: 'apt-tactic' },
          { left: 'Supply chain compromises', right: 'Targeting software vendors and updates', category: 'apt-tactic' },
          { left: 'Attribution challenges', right: 'Difficult to identify true attackers', category: 'apt-tactic' },
        ]
      }
    },
    {
      type: 'multiple-choice',
      title: 'Malware Prevention Strategies',
      description: 'Design comprehensive defense strategies against malware threats.',
      content: {
        question: 'Which combination provides the strongest defense against malware?',
        options: [
          'Strong antivirus software and user training only',
          'Multi-layered security with technical controls, policies, and continuous monitoring',
          'Network segmentation and strong perimeter security',
          'Regular backups and incident response planning'
        ],
        correct: 1,
        explanation: 'Effective malware defense requires multiple layers: technical controls, user education, monitoring, and recovery capabilities to handle various attack vectors.'
      }
    },
    {
      type: 'drag-drop',
      title: 'System Recovery Procedures',
      description: 'Categorize steps for safe system recovery after malware removal.',
      content: {
        items: [
          { id: '1', content: 'Verify malware removal with multiple tools', category: 'verification' },
          { id: '2', content: 'Change all passwords and access credentials', category: 'hardening' },
          { id: '3', content: 'Update all software and security patches', category: 'hardening' },
          { id: '4', content: 'Restore from clean, verified backups', category: 'recovery' },
          { id: '5', content: 'Implement additional monitoring', category: 'monitoring' },
          { id: '6', content: 'Conduct security assessments', category: 'verification' },
          { id: '7', content: 'Review and update security policies', category: 'hardening' },
          { id: '8', content: 'Test recovery procedures', category: 'recovery' },
        ],
        dropZones: [
          { id: 'verification', title: 'Verification Steps', description: 'Confirm clean systems and threat removal', accepts: ['verification'] },
          { id: 'recovery', title: 'Recovery Actions', description: 'Restore operations and data', accepts: ['recovery'] },
          { id: 'hardening', title: 'Hardening Measures', description: 'Strengthen security post-recovery', accepts: ['hardening'] },
          { id: 'monitoring', title: 'Monitoring Setup', description: 'Enhanced threat detection', accepts: ['monitoring'] },
        ]
      }
    },
    {
      type: 'timeline',
      title: 'Malware Forensic Investigation',
      description: 'Plan the forensic investigation timeline for malware incidents.',
      content: {
        events: [
          { id: '1', content: 'Preserve affected systems and evidence', timestamp: 'immediate' },
          { id: '2', content: 'Collect system images and memory dumps', timestamp: 'hour-1' },
          { id: '3', content: 'Analyze malware samples in sandbox', timestamp: 'hour-4' },
          { id: '4', content: 'Identify attack vectors and entry points', timestamp: 'day-1' },
          { id: '5', content: 'Map malware behavior and capabilities', timestamp: 'day-2' },
          { id: '6', content: 'Determine scope of compromise', timestamp: 'day-3' },
          { id: '7', content: 'Develop indicators of compromise (IOCs)', timestamp: 'week-1' },
          { id: '8', content: 'Share threat intelligence with security community', timestamp: 'week-2' },
        ],
        correctOrder: ['1', '2', '3', '4', '5', '6', '7', '8']
      }
    },
    {
      type: 'multiple-choice',
      title: 'Business Continuity During Malware Incidents',
      description: 'Maintain business operations while responding to malware threats.',
      content: {
        question: 'What should be the priority for business continuity during a malware outbreak?',
        options: [
          'Continue using infected systems to maintain productivity',
          'Isolate infected systems and activate backup operations',
          'Restore normal systems before investigating the incident',
          'Pay ransom quickly to resume operations'
        ],
        correct: 1,
        explanation: 'Business continuity must balance operational needs with security requirements, isolating threats while enabling business operations through clean systems.'
      }
    },
    {
      type: 'matching',
      title: 'Malware Threat Intelligence',
      description: 'Understand how to use threat intelligence for malware defense.',
      content: {
        pairs: [
          { left: 'YARA rules', right: 'Pattern matching for malware detection', category: 'intel-tools' },
          { left: 'IOCs (Indicators of Compromise)', right: 'Signatures to detect ongoing threats', category: 'intel-tools' },
          { left: 'MITRE ATT&CK framework', right: 'Adversary tactics and techniques knowledge base', category: 'intel-frameworks' },
          { left: 'Threat feeds and feeds aggregation', right: 'Real-time malware intelligence', category: 'intel-sources' },
          { left: 'Threat hunting and proactive search', right: 'Looking for threats before they attack', category: 'intel-methods' },
          { left: 'Attribution and actor tracking', right: 'Identifying malware creators and groups', category: 'intel-methods' },
        ]
      }
    },
    {
      type: 'chat',
      title: 'Advanced Malware Incident Challenge',
      description: 'Navigate a complex, multi-vector malware attack with supply chain involvement.',
      content: {
        scenario: 'You discover a sophisticated attack: malware delivered through a legitimate software update, affecting hundreds of systems, exfiltrating data, and establishing persistence. The attack shows characteristics of an APT group.',
        messages: [
          {
            id: '1',
            type: 'simulation',
            content: 'Initial analysis shows: "Compromised update from software vendor, malware has rootkit capabilities, exfiltrating data to multiple countries, discovered by unusual outbound traffic."',
            options: ['Contact the software vendor immediately', 'Disconnect all internet connections', 'Notify law enforcement and CISA', 'Focus on internal containment first']
          },
          {
            id: '2',
            type: 'simulation',
            content: 'Incident Commander: "This is a supply chain attack. We need to determine the scope, notify authorities, and assess the damage. How do we proceed?"',
            options: ['Handle this as an internal incident', 'Engage external forensic experts and authorities', 'Try to clean systems first', 'Keep this confidential for now']
          },
        ]
      }
    }
  ];

  const handleSimulationComplete = (scoreData: ScoreData) => {
    setChatHistory(prev => [...prev, {
      id: Date.now().toString(),
      type: 'system',
      content: `Malware Incident Handling completed! Score: ${scoreData.score}/${scoreData.totalQuestions}`,
      timestamp: new Date(),
    }]);
  };

  const getStepIcon = (stepIndex: number) => {
    const icons = [Bug, Shield, AlertTriangle, CheckCircle, Zap, HardDrive, Wifi, Monitor, Bug, Shield, AlertTriangle, CheckCircle, HardDrive, Monitor];
    const Icon = icons[stepIndex % icons.length];
    return <Icon className="w-6 h-6" />;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-900 via-gray-900 to-blue-900">
      <div className="container mx-auto px-4 py-8">
        <div className="mb-8">
          <div className="flex items-center space-x-4 mb-6">
            <button
              onClick={() => window.history.back()}
              className="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors"
            >
              <ArrowLeft className="w-6 h-6 text-white" />
            </button>
            <div className="flex items-center space-x-3">
              <div className="p-3 bg-green-600 rounded-lg">
                <Bug className="w-8 h-8 text-white" />
              </div>
              <div>
                <h1 className="text-3xl font-bold text-white">Malware Incident Handling</h1>
                <p className="text-gray-300">Advanced malware detection, containment, and recovery training</p>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {simulationSteps.map((step, index) => (
              <motion.div
                key={index}
                className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                  currentStep === index
                    ? 'border-green-500 bg-green-900/20'
                    : currentStep > index
                    ? 'border-green-500 bg-green-900/20'
                    : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'
                }`}
                onClick={() => setCurrentStep(index)}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
              >
                <div className="flex items-center space-x-3">
                  <div className={`p-2 rounded-lg ${
                    currentStep === index
                      ? 'bg-green-600'
                      : currentStep > index
                      ? 'bg-green-600'
                      : 'bg-gray-600'
                  }`}>
                    {currentStep > index ? (
                      <CheckCircle className="w-5 h-5 text-white" />
                    ) : (
                      getStepIcon(index)
                    )}
                  </div>
                  <div>
                    <h3 className="font-semibold text-white text-sm">{step.title}</h3>
                    <p className="text-xs text-gray-400 mt-1">{step.description}</p>
                  </div>
                </div>
              </motion.div>
            ))}
          </div>
        </div>

        <div className="bg-gray-800 rounded-lg p-6 mb-8">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold text-white">
              Step {currentStep + 1}: {simulationSteps[currentStep].title}
            </h2>
            <button
              onClick={() => setIsSimulationActive(true)}
              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
            >
              <Bug className="w-4 h-4" />
              <span>Start Simulation</span>
            </button>
          </div>

          <div className="text-gray-300 mb-4">
            {simulationSteps[currentStep].description}
          </div>

          <div className="bg-gray-900 p-4 rounded-lg">
            <p className="text-gray-400 text-sm">
              Master malware incident response through hands-on scenarios covering detection, containment, recovery, and prevention.
            </p>
          </div>
        </div>

        <AnimatePresence>
          {isSimulationActive && (
            <div className="bg-green-900/20 border border-green-500/30 rounded-lg p-6 text-center">
              <h3 className="text-xl font-bold text-green-400 mb-2">Simulation: {simulationSteps[currentStep].title}</h3>
              <p className="text-gray-300 mb-4">This interactive simulation is under development.</p>
              <p className="text-gray-400 text-sm">Advanced malware detection and recovery framework ready.</p>
              <button
                onClick={() => setIsSimulationActive(false)}
                className="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
              >
                Close Simulation
              </button>
            </div>
          )}
        </AnimatePresence>
      </div>
    </div>
  );
};

export default MalwareIncidentSimEnhanced;
